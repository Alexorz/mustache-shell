<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Mustache-shell - Demo</title>

    <link rel="stylesheet" href="./css/chico-min-0.11.1.css">
    <link rel="stylesheet" href="./css/chico-mesh.css">
    <link rel="stylesheet" href="./css/editor-ui.css">


    <script type="text/javascript" src="./js/jquery.js" ></script>
    <script type="text/javascript" src="./js/chico-min-0.11.1.js" ></script>
    <script type="text/javascript" src="./js/mustache-0.5.2-dev.js" ></script>
    <script type="text/javascript" src="./js/mustcomb/core.js" ></script>
    <script type="text/javascript" src="./js/mustcomb/tree-node.js" ></script>
    <script type="text/javascript" src="./js/mustcomb/tpl-scanner.js" ></script>
    <script type="text/javascript" src="./js/mustcomb/editor-ui-tpl.js" ></script>
    <script type="text/javascript" src="./js/mustcomb/editor-ui.js" ></script>
    <script type="text/javascript" src="./js/js-beautify.js" ></script>

    <style type="text/css">
        .icon-blue { color:#60a7f1; }
        .icon-green { color:#A4C639; }
        .icon-light-gray { color:#ddd; }

        .page-title { position: relative; padding: 20px 0 15px 0; margin-bottom:25px; border-bottom:1px solid #ccc; }
        .page-title .main-title { font-size:30px; }
        .page-title .sub-title { text-indent: 10px; font-size:12px; color: #aaa; }
        .page-title .sub-title em { color: #555; font-style: normal; }
        .page-title .control-box { position: absolute; bottom: 15px; right: 0; }
        .page-title   .extra-info-control { float: right; cursor: pointer; }
        .page-title     .extra-info-control i { color: #aaa; }
        .page-title     .show-extra-info i { color: #0637B3; }
        .page-title   .key-demo-helper    { clear: both; font-size: 14px; float: right; white-space: nowrap; }


        .flow-menu { max-width:none; margin-bottom:20px; }
        .test-suites-box { padding-bottom:20px; }


        .content-wrap { padding:15px; }

        .tpl-input,
        .tpl-input:focus,
        .form-data-json,
        .form-data-json:focus,
        .test-case-gene,
        .test-case-gene:focus { width:97%; padding:15px; min-height: 200px; color:#333; font-family: Consolas, Arial, "微软雅黑"; }
        pre { font-family: Consolas, Arial, "微软雅黑"; font-size: 11px; }

    </style>

</head>
<body>
    <div class="page-title">
        <h1 class="main-title">Mustache-shell Demo</h1>
        <h2 class="sub-title">[ <em>Template</em> + <del>JSON</del> <em>Form</em> = <em>HTML</em> ]</h2>
        
        <div class="control-box">
            <span class="extra-info-control" id="J-extra-info-control">
                <i class="ch-icon-info-sign"></i>Toggle extra info
            </span>

            <span class="key-demo-helper">
                View some key demos: 
                <select id="J-key-demo-select">
                </select>
            </span>
        </div>
    </div>

    <ul class="flow-menu ch-menu" role="navigation">
        <li class="ch-expando">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-arrow-down icon-blue"></i>Mustache Template Code Input</h2>
            <div class="content-wrap">
                <textarea id="tpl-input" class="tpl-input"></textarea>
            </div>
        </li>
        <li class="ch-expando" style="display:none;">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-info-sign icon-light-gray"></i>Data JSON Info</h2>
            <div class="content-wrap">
                <pre class="data-json-info-box" id="data-json-info-box">
                    
                </pre>
            </div>
        </li>
        <li class="ch-expando" style="display:none;">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-info-sign icon-light-gray"></i>Data JSON Demo</h2>
            <div class="content-wrap">
                <pre class="data-json-demo-box" id="data-json-demo-box">
                    
                </pre>
            </div>
        </li>
        <li class="ch-expando" style="display:none;">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-info-sign icon-light-gray"></i>Form Structure JSON</h2>
            <div class="content-wrap">
                <pre class="form-struct-json-box" id="form-struct-json-box">
                    
                </pre>
            </div>
        </li>
        <li class="ch-expando">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-arrow-down icon-blue"></i>Data Form</h2>
            <div class="content-wrap">
                <div class="data-form" id="data-form">
                    
                </div>
            </div>
        </li>
        <li class="ch-expando" style="display:none;">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-info-sign icon-light-gray"></i>Form Data JSON</h2>
            <div class="content-wrap">
                <textarea id="form-data-json" class="form-data-json"></textarea>
            </div>
        </li>
        <li class="ch-expando">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-ok icon-green"></i>Render Result:</h2>
            <div class="content-wrap">
                <div class="render-result" id="render-result">
                    
                </div>
            </div>
        </li>
        <!-- <li class="ch-expando">
            <h2 class="ch-expando-trigger ch-user-no-select" role="presentation"><i class="ch-icon-info-sign icon-light-gray"></i>Generate Case Data:</h2>
            <div class="content-wrap">
                <textarea class="test-case-gene" id="test-case-gene"></textarea>
            </div>
        </li> -->
    </ul>


    <script type="text/javascript">
        // UI init
        $(".ch-menu").menu().select(1).select(5).select(7);


        (function(){

            var ooxx = '=_-+',

            /*
             *  Configs
             */
            //
                // Local Store
                activeStorage = true && window.localStorage,
                localStoreKey = 'Mustache_Shell_Demo_Cache',
                localCache = {},
                // Usage
                responseBuffTime = 300,
            // Events
                Event = $(window),
                events = (function(){
                    var events = {},
                    eventList = [
                        'Mustache Template String Change',
                        'Editor Form Structure Change',
                        'Editor Form Data Change'
                    ];

                    for (var i = eventList.length - 1; i >= 0; i--) {
                        events[ eventList[i] ] = 'Mustache_shell_demo_' + eventList[i].replace(/[^\w\d]+/gi,'_');
                    };
                    return events;
                })(),

            // Cache Vars
                // Mustache template input area
                muArea        = $('#tpl-input'),
                // Mustache template string
                muTplStr,

                // JSON data info print
                dataInfoBox   = $('#data-json-info-box'),
                // Mustache template structure description object
                muStruct,

                // demo JSON data print
                demoDataBox   = $('#data-json-demo-box'),
                // demo JSON data for current template
                demoJSON,

                // form structor description json print
                formStructBox = $('#form-struct-json-box'),
                // form structor description object
                fmStruct,

                // editor form container
                dataFormBox   = $('#data-form'),
                // editor form object
                editorArea,

                // form data output area
                formDataArea  = $('#form-data-json'),
                // form data object
                formData,

                // render result container
                renderResBox  = $('#render-result'),

                // case
                caseDataArea  = $('#test-case-gene'),

                // Data import function
                importData = function( data ){
                    Event.trigger( events['Mustache Template String Change'], { muTplStr : data.muTplStr || '', triggeredBy : 'Import Data' } );
                    Event.trigger( events['Editor Form Data Change'], { formData : data.formData || {}, triggeredBy : 'Import Data' } );   
                };



            // Init Mustache-shell
            mustComb.setMustache( Mustache );

            /*
             * Events Binding && Triggering
             */
            //
                // Trigger Mustache Template String Change Event
                (function( tmo ){

                    function checkMuTplChange(){
                        if ( muTplStr != muArea.val() ) {
                            Event.trigger( events['Mustache Template String Change'], { muTplStr : muArea.val(), triggeredBy : 'Mustache Area' } );
                        }
                    }

                    muArea.on('blur', function(){

                        clearTimeout( tmo );
                        checkMuTplChange();

                    }).on('keyup', function(){

                        clearTimeout( tmo );
                        tmo = setTimeout(function(){
                            checkMuTplChange();
                        }, responseBuffTime );
                    });
                })();


                // Trigger Editor area data change
                (function( tmo1, tmo2 ){

                    function dataFormCheckChange( ){
                        var tmpData = editorArea.exportData();
                        if ( JSON.stringify( tmpData ) != JSON.stringify( formData ) ) {
                            Event.trigger( events['Editor Form Data Change'], { formData : tmpData, triggeredBy : 'Editor Area' } );
                        } 
                    }

                    dataFormBox.find('input').live('blur', function(){
                        clearTimeout( tmo1 );
                        dataFormCheckChange();

                    }).live('keyup', function(){

                        clearTimeout( tmo1 );
                        tmo1 = setTimeout(function(){
                            dataFormCheckChange();
                        }, responseBuffTime );
                    });

                    function formDataAreaCheckChange(){
                        var tmpData = JSON.parse( formDataArea.val() );
                        if ( JSON.stringify( tmpData ) != JSON.stringify( formData ) ) {
                            Event.trigger( events['Editor Form Data Change'], { formData : tmpData, triggeredBy : 'Form Data Area' } );
                        } 
                    }

                    formDataArea.on('blur', function(){
                        clearTimeout( tmo1 );
                        formDataAreaCheckChange();

                    }).on('keyup', function(){

                        clearTimeout( tmo1 );
                        tmo1 = setTimeout(function(){
                            formDataAreaCheckChange();
                        }, responseBuffTime );
                    });
                })();

                // When Mustache Template String Change
                Event.bind( events['Mustache Template String Change'], function( e, args ){

                    // Update Mustache template cache
                    muTplStr   = args.muTplStr;

                    // Update Mustache template input area
                    if ( args.triggeredBy != 'Mustache Area' ) {
                        muArea.val( muTplStr );
                    }

                    // Check if the structure of Mustache template has changed
                    var muStructTmp = mustComb.parse( muTplStr );
                    if ( JSON.stringify( muStructTmp ) != JSON.stringify( muStruct ) ) {
                        Event.trigger( events['Editor Form Structure Change'], { muStruct : muStructTmp } );
                    }
                });

                // When Editor Form Structure was been changed
                Event.bind( events['Editor Form Structure Change'], function( e, args ){

                    // Update Mustache template structure cache
                    muStruct   = args.muStruct;
                    dataInfoBox.text(
                        beautifyJs( JSON.stringify( muStruct ) )
                    );

                    // Update demo JSON of current template
                    demoJSON   = mustComb.getDemoJSON( muTplStr );
                    demoDataBox.text(
                        beautifyJs( JSON.stringify( demoJSON ) )
                    );

                    // Update form structure
                    fmStruct   = mustComb.getFormStruct( muTplStr );
                    formStructBox.text(
                        beautifyJs( JSON.stringify( fmStruct ) )
                    );

                    // Update editor form obj
                    editorArea = mustComb.buildEditorArea( muTplStr, dataFormBox );
                    // Reimport current date into editor area
                    editorArea.importData(
                        formData || {}
                    );

                    // Update form data json print
                    formData = editorArea.exportData();
                    formDataArea.val(
                        beautifyJs( JSON.stringify( formData ) )
                    );

                });

                // When Editor Form Data was been changed
                Event.bind( events['Editor Form Data Change'], function( e, args ){

                    // Update form data
                    formData = args.formData;

                    // Update editor area form inputs when data is updated by another module.
                    if ( args.triggeredBy != 'Editor Area' ) {
                        editorArea.importData( formData );
                    }

                    // Update form data area when data is updated by another module.
                    if ( args.triggeredBy != 'Form Data Area' ) {
                        formDataArea.val(
                            beautifyJs( JSON.stringify( formData ) )
                        );
                    }

                });

                // When to rerender HTML
                Event.bind( [
                    events['Mustache Template String Change'],
                    events['Editor Form Data Change']
                ].join(' '), function(){
                    // Rerender HTML
                    renderResBox.html(
                        mustComb.render( muTplStr, formData )
                    );
                });

                // Init Local Cache
                if ( activeStorage ) {

                    // Refresh Cache with Local Cache
                    try{
                        localCache = JSON.parse( localStorage.getItem( localStoreKey ) || '{}' );
                    }catch( e ) {
                        localCache = {};
                    }
                    muTplStr = localCache.muTplStr;
                    formData = localCache.formData;

                    // Cache custom input
                    Event.bind( [
                        events['Mustache Template String Change'],
                        events['Editor Form Data Change']
                    ].join(' '), function( e, args ){
                        if ( args.triggeredBy != 'Import Data' ) {
                            localCache.muTplStr = muTplStr;
                            localCache.formData = formData;
                            localStorage.setItem( localStoreKey, JSON.stringify( localCache ) );
                        }
                    });
                }

            // Import defaut data
            importData({
                muTplStr : muTplStr || 'Alexorz is a {{role}}.',
                formData : formData || { role : 'Coder' }
            });
            

            // Init key demo helper
            var keyDemoList = [
                    {
                        name : 'Hello world',
                        muTplStr : 'Alexorz is a {{role}}.',
                        formData : { role : 'Coder' }
                    },
                    {
                        name : 'Array',
                        muTplStr : '{{!meta=[ type:"array" ]}}\n{{#words}}\n  {{someone}} is a {{role}}.<br />\n{{/words}}',
                        formData : { words : [ { someone : 'Alexorz', role: 'Coder' }, { someone : 'Jackie', role: 'Actor' } ] }
                    },
                    {
                        name : 'Object',
                        muTplStr : '{{!meta=[ type:"object" ]}}\n{{#word}}\n  {{someone}} is a {{role}}.\n{{/word}}',
                        formData : { word : { someone : 'Alexorz', role: 'Coder' } }
                    },
                    {
                        name : 'Name',
                        muTplStr : '{{!meta=[ name:"What kind of people" ]}}\nAlexorz is a {{role}}.',
                        formData : { role : 'Coder' }
                    }

                ],
                keyDemoSelect = $('#J-key-demo-select');

            for (var i = 0; i < keyDemoList.length; i++) {
                var curr = keyDemoList[i];
                keyDemoSelect.append('<option value="'+ i +'">'+ curr.name +'</option>');
            }

            keyDemoSelect.change(function(){
                importData( keyDemoList[ Number(this.value) || 0 ] );
            });


            // Toggle extra info
            $('#J-extra-info-control').click(function(){
                $(this).toggleClass('show-extra-info');
                dataInfoBox.parents('.ch-expando').toggle();
                demoDataBox.parents('.ch-expando').toggle();
                formStructBox.parents('.ch-expando').toggle();

                return false;
            });

        })();

    </script>
</body>
</html>